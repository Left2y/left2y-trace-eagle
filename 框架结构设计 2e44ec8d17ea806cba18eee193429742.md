# 框架结构设计

# ③ 框架结构设计文档（Architecture / Design）

## 1. 总体架构（分层）

插件采用 **Window Plugin**：一个 UI 页面（渲染层）+ Node 执行层（同环境可直接调用 Node API）。

建议分 5 层模块：

1. **UI Layer（Renderer）**
    - 参数面板、预设、文件列表、进度、错误展示
2. **Application Layer（Use Cases）**
    - “转换选中项”用例：校验 → 排队 → 执行 → 回写 → 汇总
3. **Core Pipeline（Image→PBM→SVG）**
    - mkbitmap runner / potrace runner / 参数映射 / 结果校验
4. **Adapters**
    - EagleAdapter：getSelected / addFromPath /（可选）metadata 写入
    - FSAdapter：temp dir、清理、输出路径管理
5. **Infrastructure**
    - BinResolver（按 OS/arch 找到 mkbitmap/potrace 可执行文件）
    - TaskQueue（串行或有限并发）
    - SettingsStore（localStorage/JSON）

## 2. 关键依赖与约束

- Eagle 插件运行在 Chromium 107 + Node 16，可用 Node 原生 API 与第三方模块。
- 数据读写必须通过 Item API 的 `save()`，避免直接改库内文件（最佳实践）。

## 3. 目录结构建议（仓库）

```
eagle-raster-to-vector/
  manifest.json
  index.html
  assets/
    icon.png
  src/
    ui/
      app.ts
      components/
      styles.css
    app/
      convertSelected.ts
      preset.ts
      settings.ts
    core/
      pipeline.ts
      mkbitmap.ts
      potrace.ts
      params.ts
      validate.ts
    adapters/
      eagleAdapter.ts
      fsAdapter.ts
      binResolver.ts
      taskQueue.ts
  bin/
    darwin-arm64/
      mkbitmap
      potrace
    darwin-x64/
      mkbitmap
      potrace
    win32-x64/
      mkbitmap.exe
      potrace.exe
    linux-x64/
      mkbitmap
      potrace
  LICENSE
  THIRD_PARTY_NOTICES.md
  README.md

```

> 注：bin 内直接带可执行文件（你开源且不考虑商业化更简单），并在 README 写明来源/版本；mkbitmap/potrace 为 GPL。
> 

## 4. 模块设计

### 4.1 EagleAdapter（与 Eagle API 的边界）

- `getSelectedItems()`
    - 调用：`eagle.item.getSelected()`
    - 若只需要少量字段，优先用 `get({ isSelected: true, fields:[...] })` 优化性能（同 item API 支持 fields）。
- `addSvgToLibrary(svgPath, options)`
    - 调用：`eagle.item.addFromPath(svgPath, options)`
- `updateItem(item)`
    - 改属性后 `item.save()`

### 4.2 Pipeline（核心转换链）

`pipeline.convertOne(inputPath, params) -> { svgPath, stats }`

步骤：

1. `mkbitmap`
    - 输入：原图（若非 PNM/BMP，可先用内置解码方案：**建议 MVP 限制输入为 PNG/JPG/BMP**，并用第三方库转 BMP/PNM；或让用户仅处理 Eagle 常见图片格式）
    - 输出：PBM
    - 操作与参数：滤波/缩放/阈值/反相等
2. `potrace --svg --tight ...`
    - alphamax：角点阈值（0=多边形，越小越尖，>4/3 更平滑）
    - opttolerance：曲线优化容差（越大越省节点但越不精确）
    - turdsize：去斑点像素数阈值
    - tight：裁掉外围空白
    - blacklevel：若直接让 potrace 做灰度阈值转换；但本方案主要交给 mkbitmap，因为官方也明确 mkbitmap 的插值放大+阈值化能更好保留细节。

### 4.3 参数映射（UI → 命令行）

建议做一个统一的数据结构，避免 UI 直接拼命令：

- `MkbitmapParams`
    - invert(bool) → `i`
    - filterRadius(number) → `f n`
    - blur(number) → `b n`
    - scale(int) → `s n`
    - threshold(0..1) → `t n`
    - interpolation: cubic(default `3`) / linear(`1`)
    - nodefaults(bool) → `x`（高级选项：关闭默认预设）
- `PotraceParams`
    - alphamax(number) → `a n`
    - opttolerance(number) → `O n`
    - turdsize(int) → `t n`
    - tight(bool) → `-tight`
    - svg(always) → `-svg`
    - group/flat（可选增强）→ `-group` / `-flat`

## 5. 任务队列与并发策略

- **MVP 推荐：串行处理**（最稳，日志与错误定位简单）
- P1：有限并发（例如同时 2 个）
    - 注意：mkbitmap/potrace 进程密集，过高并发会拖慢 UI

## 6. 事件生命周期（Eagle 插件）

- `eagle.onPluginCreate(cb)`：初始化（加载配置、检测 bin、绑定 UI）
- `eagle.onPluginRun(cb)`：用户点击插件时触发（刷新选中列表）
- `onbeforeunload`：若任务进行中，阻止关闭或提示确认

## 7. 临时文件与清理

- 每次运行创建 temp 目录：`{pluginPath}/tmp/{timestamp}/`
- 每张图输出：
    - `input.(normalized).bmp|pnm`
    - `out.pbm`
    - `out.svg`
    - `stderr.log`
- 清理策略（MVP）：
    - 成功：默认清理 PBM 与中间文件，仅保留 SVG（或全部清理，SVG 由 Eagle 导入后可删除本地临时）
    - 失败：保留临时目录，方便排错（UI 提供“打开临时目录”按钮）

## 8. 二进制分发与定位（BinResolver）

- 根据 `process.platform` / `process.arch` 选择 `bin/<platform-arch>/` 下的 potrace/mkbitmap
- 启动前做一次自检：执行 `-version`（或 `v`）验证可运行（mkbitmap 支持 `-version`）。